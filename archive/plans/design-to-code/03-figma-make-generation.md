# 03 - Figma Make Integration

> **Goal**: Enable Figma Make to generate production-ready code that directly invokes AFD commands, with full design token and UX pattern support.

## Overview

Figma Make generates functional React/Tailwind code from designs. This integration ensures that generated code:

1. **Invokes AFD commands** instead of hardcoded logic
2. **Respects command schemas** for type safety
3. **Handles UX fields** (confidence, warnings, etc.)
4. **Uses design tokens** that map to AFD patterns

## The Generation Pipeline

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          FIGMA MAKE PIPELINE                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐             │
│  │ Figma Design │───►│  AFD Plugin  │───►│ Figma Make   │             │
│  │ + Bindings   │    │  Metadata    │    │     AI       │             │
│  └──────────────┘    └──────────────┘    └──────┬───────┘             │
│                                                  │                      │
│                                                  ▼                      │
│                                         ┌──────────────┐               │
│                                         │  Generated   │               │
│                                         │    Code      │               │
│                                         └──────┬───────┘               │
│                                                │                        │
│                      ┌─────────────────────────┼─────────────────────┐ │
│                      ▼                         ▼                     ▼ │
│               ┌────────────┐           ┌────────────┐        ┌────────┐│
│               │ Component  │           │  MCP/API   │        │ Types  ││
│               │    JSX     │           │   Calls    │        │  .d.ts ││
│               └────────────┘           └────────────┘        └────────┘│
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## Context Injection for Figma Make

When Figma Make generates code, it needs AFD context. This is provided through:

### 1. Design Metadata (from Plugin)

The AFD Design Bridge plugin stores metadata in Figma:

```json
{
  "afd-command": "todo.create",
  "afd-bindings": {
    "inputs": {
      "titleInput": "title",
      "prioritySelect": "priority"
    },
    "outputs": {
      "errorBanner": "error",
      "confidenceIndicator": "confidence"
    },
    "action": "submitButton"
  },
  "afd-schema": {
    "input": {
      "title": { "type": "string", "required": true },
      "priority": { "type": "enum", "values": ["high", "medium", "low"] }
    },
    "output": {
      "uxFields": ["confidence", "warnings"]
    }
  }
}
```

### 2. AFD Prompt Context

Inject into Figma Make's generation prompt:

```markdown
## AFD Integration Context

This component is bound to AFD command: `todo.create`

### Command Schema
- **Input**: `{ title: string (required), priority: "high" | "medium" | "low" }`
- **Output**: `CommandResult<Todo>` with UX fields: confidence, warnings

### Code Generation Rules
1. Import the AFD client: `import { afd } from '@/lib/afd-client'`
2. Call commands via: `await afd.call('todo.create', { title, priority })`
3. Handle CommandResult structure:
   - Check `result.success` before accessing `result.data`
   - Display `result.error.message` and `result.error.suggestion` on failure
   - Show confidence indicator if `result.confidence < 0.9`
   - Render warnings from `result.warnings` array

### Input Bindings
- Layer "titleInput" → maps to `title` input field
- Layer "prioritySelect" → maps to `priority` select

### Output Bindings
- Layer "errorBanner" → show when `!result.success`
- Layer "confidenceIndicator" → show `result.confidence`

### UX Patterns
Use these patterns for CommandResult fields:
- confidence < 0.7: Show warning state, require confirmation
- warnings.length > 0: Show alert banner above form
- error.suggestion: Display as actionable hint below error message
```

## Generated Code Examples

### Basic Form Component

**Input**: Figma design bound to `todo.create`

**Output**:

```tsx
// components/TodoCreateForm.tsx
// Generated by Figma Make with AFD integration

import { useState } from 'react';
import { afd } from '@/lib/afd-client';
import type { CommandResult, Todo } from '@/types/afd';

interface TodoCreateFormProps {
  onSuccess?: (todo: Todo) => void;
  onError?: (error: { code: string; message: string }) => void;
}

export function TodoCreateForm({ onSuccess, onError }: TodoCreateFormProps) {
  const [title, setTitle] = useState('');
  const [priority, setPriority] = useState<'high' | 'medium' | 'low'>('medium');
  const [isLoading, setIsLoading] = useState(false);
  const [result, setResult] = useState<CommandResult<Todo> | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setResult(null);

    try {
      const commandResult = await afd.call('todo.create', { title, priority });
      setResult(commandResult);

      if (commandResult.success) {
        onSuccess?.(commandResult.data!);
        setTitle('');
        setPriority('medium');
      } else {
        onError?.(commandResult.error!);
      }
    } catch (err) {
      setResult({
        success: false,
        error: { code: 'NETWORK_ERROR', message: 'Failed to connect to server' },
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4 p-6 bg-white rounded-lg shadow">
      {/* Warnings Banner */}
      {result?.warnings && result.warnings.length > 0 && (
        <div className="p-3 bg-yellow-50 border border-yellow-200 rounded-md">
          {result.warnings.map((warning, i) => (
            <p key={i} className="text-sm text-yellow-800">{warning.message}</p>
          ))}
        </div>
      )}

      {/* Error Banner */}
      {result && !result.success && result.error && (
        <div className="p-3 bg-red-50 border border-red-200 rounded-md">
          <p className="text-sm font-medium text-red-800">{result.error.message}</p>
          {result.error.suggestion && (
            <p className="text-sm text-red-600 mt-1">{result.error.suggestion}</p>
          )}
        </div>
      )}

      {/* Title Input */}
      <div className="space-y-1">
        <label htmlFor="title" className="block text-sm font-medium text-gray-700">
          Title <span className="text-red-500">*</span>
        </label>
        <input
          id="title"
          type="text"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          required
          minLength={1}
          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
          placeholder="Enter todo title"
        />
      </div>

      {/* Priority Select */}
      <div className="space-y-1">
        <label htmlFor="priority" className="block text-sm font-medium text-gray-700">
          Priority
        </label>
        <select
          id="priority"
          value={priority}
          onChange={(e) => setPriority(e.target.value as 'high' | 'medium' | 'low')}
          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
        >
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
      </div>

      {/* Submit Button */}
      <button
        type="submit"
        disabled={isLoading || !title}
        className="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        {isLoading ? 'Creating...' : 'Create Todo'}
      </button>

      {/* Confidence Indicator */}
      {result?.success && result.confidence !== undefined && result.confidence < 0.9 && (
        <div className="flex items-center gap-2 p-2 bg-gray-50 rounded">
          <div 
            className="h-2 w-16 bg-gray-200 rounded-full overflow-hidden"
            title={`Confidence: ${Math.round(result.confidence * 100)}%`}
          >
            <div 
              className="h-full bg-yellow-500 rounded-full"
              style={{ width: `${result.confidence * 100}%` }}
            />
          </div>
          <span className="text-xs text-gray-500">
            {result.confidence < 0.7 ? 'Please verify' : 'Review recommended'}
          </span>
        </div>
      )}
    </form>
  );
}
```

### AFD Client Library

Generated/provided client for invoking commands:

```typescript
// lib/afd-client.ts

import type { CommandResult } from '@/types/afd';

interface AFDClientConfig {
  baseUrl: string;
  transport: 'mcp' | 'rest';
}

class AFDClient {
  private config: AFDClientConfig;

  constructor(config: AFDClientConfig) {
    this.config = config;
  }

  async call<T>(command: string, input: Record<string, unknown>): Promise<CommandResult<T>> {
    if (this.config.transport === 'mcp') {
      return this.callViaMCP(command, input);
    }
    return this.callViaREST(command, input);
  }

  private async callViaMCP<T>(command: string, input: Record<string, unknown>): Promise<CommandResult<T>> {
    // MCP SSE transport
    const response = await fetch(`${this.config.baseUrl}/sse`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        jsonrpc: '2.0',
        method: 'tools/call',
        params: { name: command, arguments: input },
        id: Date.now(),
      }),
    });

    const result = await response.json();
    return result.result as CommandResult<T>;
  }

  private async callViaREST<T>(command: string, input: Record<string, unknown>): Promise<CommandResult<T>> {
    // REST API transport
    const response = await fetch(`${this.config.baseUrl}/api/${command}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(input),
    });

    return response.json() as Promise<CommandResult<T>>;
  }
}

export const afd = new AFDClient({
  baseUrl: process.env.NEXT_PUBLIC_AFD_URL || 'http://localhost:3100',
  transport: 'mcp',
});
```

### Generated Types

```typescript
// types/afd.ts

export interface CommandResult<T> {
  success: boolean;
  data?: T;
  error?: CommandError;
  confidence?: number;
  reasoning?: string;
  sources?: Source[];
  warnings?: Warning[];
  plan?: PlanStep[];
  alternatives?: Alternative<T>[];
}

export interface CommandError {
  code: string;
  message: string;
  suggestion?: string;
  retryable?: boolean;
}

export interface Warning {
  code: string;
  message: string;
  severity: 'info' | 'warning' | 'caution';
}

export interface Source {
  type: string;
  id?: string;
  title?: string;
  url?: string;
}

export interface PlanStep {
  id: string;
  action: string;
  status: 'pending' | 'in_progress' | 'complete' | 'failed';
  description?: string;
}

export interface Alternative<T> {
  data: T;
  reason: string;
  confidence?: number;
}

// Domain types (generated from schema.export)
export interface Todo {
  id: string;
  title: string;
  priority: 'high' | 'medium' | 'low';
  completed: boolean;
  createdAt: string;
}
```

## UX Pattern Components

Pre-built components for CommandResult UX fields:

### Confidence Indicator

```tsx
// components/afd/ConfidenceIndicator.tsx

interface ConfidenceIndicatorProps {
  value: number;
  showLabel?: boolean;
}

export function ConfidenceIndicator({ value, showLabel = true }: ConfidenceIndicatorProps) {
  const getColor = () => {
    if (value >= 0.9) return 'bg-green-500';
    if (value >= 0.7) return 'bg-yellow-500';
    if (value >= 0.5) return 'bg-orange-500';
    return 'bg-red-500';
  };

  const getLabel = () => {
    if (value >= 0.9) return 'High confidence';
    if (value >= 0.7) return 'Review recommended';
    if (value >= 0.5) return 'Please verify';
    return 'Low confidence';
  };

  return (
    <div className="flex items-center gap-2">
      <div className="h-2 w-20 bg-gray-200 rounded-full overflow-hidden">
        <div 
          className={`h-full ${getColor()} rounded-full transition-all`}
          style={{ width: `${value * 100}%` }}
        />
      </div>
      {showLabel && (
        <span className="text-xs text-gray-500">{getLabel()}</span>
      )}
    </div>
  );
}
```

### Warning Banner

```tsx
// components/afd/WarningBanner.tsx

interface WarningBannerProps {
  warnings: Warning[];
  onDismiss?: (index: number) => void;
}

export function WarningBanner({ warnings, onDismiss }: WarningBannerProps) {
  if (warnings.length === 0) return null;

  const getSeverityStyles = (severity: Warning['severity']) => {
    switch (severity) {
      case 'info':
        return 'bg-blue-50 border-blue-200 text-blue-800';
      case 'warning':
        return 'bg-yellow-50 border-yellow-200 text-yellow-800';
      case 'caution':
        return 'bg-orange-50 border-orange-200 text-orange-800';
    }
  };

  return (
    <div className="space-y-2">
      {warnings.map((warning, index) => (
        <div 
          key={index}
          className={`p-3 border rounded-md flex justify-between items-start ${getSeverityStyles(warning.severity)}`}
        >
          <p className="text-sm">{warning.message}</p>
          {onDismiss && (
            <button 
              onClick={() => onDismiss(index)}
              className="text-current opacity-50 hover:opacity-100"
            >
              ×
            </button>
          )}
        </div>
      ))}
    </div>
  );
}
```

### Error Display

```tsx
// components/afd/ErrorDisplay.tsx

interface ErrorDisplayProps {
  error: CommandError;
  onRetry?: () => void;
}

export function ErrorDisplay({ error, onRetry }: ErrorDisplayProps) {
  return (
    <div className="p-4 bg-red-50 border border-red-200 rounded-md">
      <div className="flex items-start gap-3">
        <span className="text-red-500 text-xl">⚠️</span>
        <div className="flex-1">
          <p className="font-medium text-red-800">{error.message}</p>
          {error.suggestion && (
            <p className="mt-1 text-sm text-red-600">{error.suggestion}</p>
          )}
          {error.retryable && onRetry && (
            <button
              onClick={onRetry}
              className="mt-2 text-sm text-red-700 underline hover:no-underline"
            >
              Try again
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
```

## Integration with Figma Make

### Custom Generation Rules

Create a `.figma-make.json` config:

```json
{
  "afd": {
    "enabled": true,
    "clientImport": "@/lib/afd-client",
    "typesImport": "@/types/afd",
    "componentImports": {
      "ConfidenceIndicator": "@/components/afd/ConfidenceIndicator",
      "WarningBanner": "@/components/afd/WarningBanner",
      "ErrorDisplay": "@/components/afd/ErrorDisplay"
    },
    "patterns": {
      "form": {
        "wrapInForm": true,
        "handleSubmit": true,
        "showLoading": true
      },
      "list": {
        "useSWR": true,
        "showEmpty": true,
        "showError": true
      }
    }
  }
}
```

### Figma Make Prompt Template

```markdown
# AFD Component Generation

You are generating a React component from a Figma design that is bound to an AFD command.

## Component: {{componentName}}
## Bound Command: {{commandName}}

## Schema
{{schemaJson}}

## Bindings
{{bindingsJson}}

## Requirements

1. **State Management**
   - Use useState for form inputs
   - Track loading state during command execution
   - Store CommandResult for displaying feedback

2. **Command Invocation**
   - Import: `import { afd } from '{{clientImport}}'`
   - Call: `const result = await afd.call('{{commandName}}', input)`
   - Always check `result.success` before accessing `result.data`

3. **Error Handling**
   - Display `result.error.message` prominently
   - Show `result.error.suggestion` as helper text
   - Enable retry if `result.error.retryable` is true

4. **UX Fields**
   {{#each uxFields}}
   - **{{this}}**: {{uxFieldGuidance this}}
   {{/each}}

5. **Accessibility**
   - Required fields marked with asterisk and aria-required
   - Error messages linked with aria-describedby
   - Focus management on submit

Generate the complete React component with TypeScript types.
```

## Code Export Workflow

1. **Designer completes design** with AFD bindings
2. **Export triggered** via Figma Make
3. **Context assembled**:
   - Design layers and properties
   - AFD bindings from plugin data
   - Schema from `schema.describe`
   - UX patterns from `schema.uxPatterns`
4. **Prompt constructed** with all context
5. **Code generated** by Figma Make AI
6. **Post-processing**:
   - TypeScript type checking
   - ESLint/Prettier formatting
   - Import optimization

## Success Criteria

- [ ] Generated components compile without TypeScript errors
- [ ] Commands invoked correctly with proper input types
- [ ] Error states handled per CommandResult spec
- [ ] UX fields rendered appropriately
- [ ] Loading states shown during async operations
- [ ] Accessibility requirements met
- [ ] Code follows project style guide

---

**Next**: [04-documentation-pipeline.md](./04-documentation-pipeline.md) — Auto-generating documentation
